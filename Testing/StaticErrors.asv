close all

% Connect whith AnalogIn Module
conn = AnalogModule('COM13');
global AnalogModuleSystem

% Connect with Pulse Pal Wave Generator
WaveGen=PulsePalWaveGen('COM14');
WaveGen.playbackMode = 'triggered';

ProgramAnalogModuleParam('VoltageRange', 1:8, 1*ones(1,8)); %-10V to 10V
SamplingPeriod = 50; %in ms
ProgramAnalogModuleParam('SamplingPeriod', SamplingPeriod);

duration = 1; % seconds
WaveGen.customWaveformSF = 10;
WaveGen.customWaveform = 0*zeros(1,duration*WaveGen.customWaveformSF);
WaveGen.waveform = 'custom';

ChannelToTest = 7;
PointsToTest = -10:20/(20-1):10;
nPoints = size(PointsToTest,2);

for i=1:nPoints

    WaveGen.customWaveform = PointsToTest(i)*ones(1,duration*WaveGen.customWaveformSF);
    pause(0.5);
    
    trigger(WaveGen)
        
    StartLogging;

    pause(duration-0.)

    data = RetrieveData;
    xdata = data.x;
    ydata = data.y;
    
    hold on
    plot(data.x,data.y)
    axis([0 data.x(end) -12 12])
    
    y = ydata(ChannelToTest+1,ceil(400/SamplingPeriod):end);
    MeasuredPoint(i) = mean(y);
    MeasuredPointSE(i) = std(y)/sqrt(size(y,2));
end

figure
hold on
errorbar(PointsToTest,MeasuredPoint,MeasuredPointSE/2,'.','MarkerSize',10)
axis([-11 11 -11 11]);
p = polyfit(PointsToTest,MeasuredPoint,1);
pfit = polyval(p,-10:10);
plot(-10:10,pfit)

text(-9,10,['Gain error: ' num2str(100*(1-p(1)),'%1.2f') '%'],'FontSize',12)
text(-9,8,['Offset error: ' num2str(p(2),'%1.3f') 'V'],'FontSize',12)

disp(['Gain error: ' num2str(100*(1-p(1)),'%1.2f') '%'])
disp(['Offset error: ' num2str(p(2),'%1.3f') 'V'])



